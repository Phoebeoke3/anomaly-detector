<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anomaly Detection Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet">
    <style>
        .status-card {
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .status-normal { 
            background-color: #d4edda;
            border-left: 5px solid #28a745;
        }
        .status-warning { 
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
        }
        .status-critical { 
            background-color: #f8d7da;
            border-left: 5px solid #dc3545;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }
        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }
        .large-chart-container {
            height: 400px;
            margin-bottom: 20px;
        }
        .refresh-time {
            font-size: 12px;
            color: #6c757d;
        }
        .anomaly-score {
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 8px;
        }
        .anomaly-normal {
            background-color: #28a745;
            color: white;
        }
        .anomaly-warning {
            background-color: #ffc107;
            color: black;
        }
        .anomaly-critical {
            background-color: #dc3545;
            color: white;
        }
        .gauge-container {
            text-align: center;
            margin: 10px 0;
        }
        .gauge {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            background: conic-gradient(#28a745 0deg, #28a745 180deg, #ffc107 180deg, #ffc107 270deg, #dc3545 270deg, #dc3545 360deg);
        }
        .gauge::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 50%;
        }
        .gauge-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            font-weight: bold;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">{{ company.name }} - Wind Turbine Anomaly Detection Dashboard</span>
            <span class="text-light">{{ company.facility }}</span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Debug Info -->
        <div class="debug-info">
            <strong>Last Updated:</strong> <span id="debug-time"></span>
            <br>
            <strong>Thresholds:</strong> Warning: <span id="warning-threshold">--</span> | Critical: <span id="critical-threshold">--</span>
            <br>
            <strong>Current Anomaly Scores:</strong> <span id="anomaly-scores">--</span>
        </div>

        <!-- System Overview -->
        <div class="row">
            <div class="col-md-3">
                <div class="status-card">
                    <h5>System Status</h5>
                    <div id="system-status">
                        <p>Loading...</p>
                    </div>
                    <div class="refresh-time" id="last-update"></div>
                </div>
            </div>
            <div class="col-md-9">
                <div class="status-card">
                    <h5>System Statistics</h5>
                    <div class="stats-grid" id="system-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="total-lines">0</div>
                            <div class="stat-label">Turbine Lines</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="normal-lines">0</div>
                            <div class="stat-label">Normal</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="warning-lines">0</div>
                            <div class="stat-label">Warning</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="critical-lines">0</div>
                            <div class="stat-label">Critical</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Production Lines -->
        <div class="row">
            <div class="col-12">
                <div class="status-card">
                    <h5>Turbine Lines Status</h5>
                    <div class="row" id="production-lines">
                        <!-- Production lines will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Sensor Charts -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="status-card">
                    <h5>Blade Temperature Trends</h5>
                    <div class="chart-container">
                        <canvas id="temperature-chart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="status-card">
                    <h5>Blade Humidity Trends</h5>
                    <div class="chart-container">
                        <canvas id="humidity-chart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="status-card">
                    <h5>Blade Sound Level Trends</h5>
                    <div class="chart-container">
                        <canvas id="sound-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Anomaly Analysis -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="status-card">
                    <h5>Anomaly Score Distribution</h5>
                    <div class="large-chart-container">
                        <canvas id="anomaly-distribution-chart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="status-card">
                    <h5>Historical Anomaly Trends</h5>
                    <div class="large-chart-container">
                        <canvas id="anomaly-trend-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sensor Correlation Matrix -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="status-card">
                    <h5>Sensor Correlation Analysis</h5>
                    <div class="large-chart-container">
                        <canvas id="correlation-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Debug info
        document.getElementById('debug-time').textContent = new Date().toLocaleString();
        console.log('Dashboard loaded successfully');

        // Global data storage
        let historicalData = {
            temperature: [],
            humidity: [],
            sound: [],
            anomaly_scores: [],
            timestamps: []
        };
        let chartsLoaded = false;
        let charts = {};

        // Initialize charts after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize charts
            charts = {
                temperature: new Chart(document.getElementById('temperature-chart'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Temperature (°C)',
                            data: [],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                suggestedMin: 15,
                                suggestedMax: 35,
                                title: {
                                    display: true,
                                    text: 'Temperature (°C)'
                                }
                            }
                        }
                    }
                }),
                humidity: new Chart(document.getElementById('humidity-chart'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Humidity (%)',
                            data: [],
                            borderColor: 'rgb(153, 102, 255)',
                            backgroundColor: 'rgba(153, 102, 255, 0.1)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                suggestedMin: 30,
                                suggestedMax: 70,
                                title: {
                                    display: true,
                                    text: 'Humidity (%)'
                                }
                            }
                        }
                    }
                }),
                sound: new Chart(document.getElementById('sound-chart'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Sound Level (dB)',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                suggestedMin: 40,
                                suggestedMax: 80,
                                title: {
                                    display: true,
                                    text: 'Sound Level (dB)'
                                }
                            }
                        }
                    }
                }),
                anomalyDistribution: new Chart(document.getElementById('anomaly-distribution-chart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Normal', 'Warning', 'Critical'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(220, 53, 69, 0.8)'
                            ],
                            borderColor: [
                                'rgb(40, 167, 69)',
                                'rgb(255, 193, 7)',
                                'rgb(220, 53, 69)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                }),
                anomalyTrend: new Chart(document.getElementById('anomaly-trend-chart'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Anomaly Score',
                            data: [],
                            borderColor: 'rgb(255, 159, 64)',
                            backgroundColor: 'rgba(255, 159, 64, 0.1)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1,
                                title: {
                                    display: true,
                                    text: 'Anomaly Score'
                                }
                            }
                        }
                    }
                }),
                correlation: new Chart(document.getElementById('correlation-chart'), {
                    type: 'radar',
                    data: {
                        labels: ['Temperature', 'Humidity', 'Sound Level'],
                        datasets: [{
                            label: 'Current Values',
                            data: [0, 0, 0],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            pointBackgroundColor: 'rgb(54, 162, 235)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(54, 162, 235)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    stepSize: 20
                                }
                            }
                        }
                    }
                })
            };

            console.log('All charts initialized successfully');

            // Show loading state and fetch historical data
            showChartLoading();
            fetchAndPlotHistory('temperature', charts.temperature);
            fetchAndPlotHistory('humidity', charts.humidity);
            fetchAndPlotHistory('sound_level', charts.sound);
        });

        // Update chart data
        function updateChart(chart, newValue, maxPoints = 20) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            
            chart.data.labels.push(timeStr);
            chart.data.datasets[0].data.push(newValue);
            
            // Keep only the last maxPoints points
            if (chart.data.labels.length > maxPoints) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            
            chart.update('none'); // Disable animations for real-time updates
        }

        // Update anomaly distribution chart
        function updateAnomalyDistribution(normal, warning, critical) {
            charts.anomalyDistribution.data.datasets[0].data = [normal, warning, critical];
            charts.anomalyDistribution.update();
        }

        // Update anomaly trend chart
        function updateAnomalyTrend(score) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            
            charts.anomalyTrend.data.labels.push(timeStr);
            charts.anomalyTrend.data.datasets[0].data.push(score);
            
            if (charts.anomalyTrend.data.labels.length > 15) {
                charts.anomalyTrend.data.labels.shift();
                charts.anomalyTrend.data.datasets[0].data.shift();
            }
            
            charts.anomalyTrend.update('none');
        }

        // Update correlation chart
        function updateCorrelationChart(temp, humidity, sound) {
            // Normalize values to 0-100 scale
            const normalizedTemp = ((temp - 15) / (35 - 15)) * 100;
            const normalizedHumidity = ((humidity - 30) / (70 - 30)) * 100;
            const normalizedSound = ((sound - 40) / (80 - 40)) * 100;
            
            charts.correlation.data.datasets[0].data = [normalizedTemp, normalizedHumidity, normalizedSound];
            charts.correlation.update();
        }

        // Get status class based on anomaly status
        function getStatusClass(status) {
            switch(status) {
                case 'normal': return 'status-normal';
                case 'warning': return 'status-warning';
                case 'critical': return 'status-critical';
                default: return 'status-normal';
            }
        }

        // Get anomaly score class
        function getAnomalyScoreClass(score) {
            if (score >= 0.8) return 'anomaly-critical';
            if (score >= 0.6) return 'anomaly-warning';
            return 'anomaly-normal';
        }

        // Update system statistics
        function updateSystemStats(data) {
            const lines = Object.values(data);
            const normal = lines.filter(line => line.status === 'normal').length;
            const warning = lines.filter(line => line.status === 'warning').length;
            const critical = lines.filter(line => line.status === 'critical').length;
            
            document.getElementById('total-lines').textContent = lines.length;
            document.getElementById('normal-lines').textContent = normal;
            document.getElementById('warning-lines').textContent = warning;
            document.getElementById('critical-lines').textContent = critical;
            
            updateAnomalyDistribution(normal, warning, critical);
            
            // Update debug information
            const anomalyScores = lines.map(line => `${line.name}: ${line.anomaly_score.toFixed(3)}`).join(', ');
            document.getElementById('anomaly-scores').textContent = anomalyScores;
        }

        // Fetch and plot historical data for a sensor
        function fetchAndPlotHistory(sensorType, chart) {
            fetch(`/api/sensor-history/${sensorType}`)
                .then(response => response.json())
                .then(data => {
                    // Sort by timestamp ascending
                    data.sort((a, b) => a.timestamp - b.timestamp);
                    const labels = data.map(d => new Date(d.timestamp * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
                    const values = data.map(d => d.value);
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = values;
                    chart.update();
                    chartsLoaded = true;
                })
                .catch(error => {
                    console.error(`Error fetching historical data for ${sensorType}:`, error);
                });
        }

        // Show loading state for charts
        function showChartLoading() {
            charts.temperature.data.labels = ['Loading...'];
            charts.temperature.data.datasets[0].data = [null];
            charts.temperature.update();
            charts.humidity.data.labels = ['Loading...'];
            charts.humidity.data.datasets[0].data = [null];
            charts.humidity.update();
            charts.sound.data.labels = ['Loading...'];
            charts.sound.data.datasets[0].data = [null];
            charts.sound.update();
        }

        // Update dashboard data
        function updateDashboard() {
            // Fetch thresholds
            fetch('/api/thresholds')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('warning-threshold').textContent = data.warning_threshold.toFixed(3);
                    document.getElementById('critical-threshold').textContent = data.critical_threshold.toFixed(3);
                })
                .catch(error => {
                    console.error('Error fetching thresholds:', error);
                });

            fetch('/api/current-status')
                .then(response => response.json())
                .then(data => {
                    // Update system status
                    const systemStatus = document.getElementById('system-status');
                    systemStatus.innerHTML = `
                        <p><strong>Model Status:</strong> ${data.model_status.status}</p>
                        <p><strong>Health Status:</strong> ${data.health_status.status}</p>
                        <p><strong>Model Version:</strong> ${data.model_status.version}</p>
                    `;

                    // Update last update time
                    document.getElementById('last-update').textContent = 
                        `Last updated: ${new Date(data.timestamp).toLocaleTimeString()}`;
                })
                .catch(error => {
                    console.error('Error fetching system status:', error);
                });

            // Update production lines
            fetch('/api/production-lines')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('production-lines');
                    container.innerHTML = '';
                    
                    let avgTemp = 0, avgHumidity = 0, avgSound = 0, avgAnomaly = 0;
                    let count = 0;
                    
                    Object.entries(data).forEach(([lineId, line]) => {
                        const statusClass = getStatusClass(line.status);
                        const anomalyScoreClass = getAnomalyScoreClass(line.anomaly_score);
                        
                        avgTemp += line.sensors.temperature;
                        avgHumidity += line.sensors.humidity;
                        avgSound += line.sensors.sound_level;
                        avgAnomaly += line.anomaly_score;
                        count++;
                        
                        const card = document.createElement('div');
                        card.className = 'col-md-6 col-lg-4 mb-3';
                        card.innerHTML = `
                            <div class="status-card ${statusClass}">
                                <h5>${line.name}</h5>
                                <p><small>Components: ${line.components.join(', ')}</small></p>
                                <div class="row">
                                    <div class="col-4">
                                        <div class="metric-value" id="${lineId}-temp">--</div>
                                        <small>Blade Temperature</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="metric-value" id="${lineId}-humidity">--</div>
                                        <small>Blade Humidity</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="metric-value" id="${lineId}-sound">--</div>
                                        <small>Blade Sound</small>
                                    </div>
                                </div>
                                <div class="anomaly-score ${anomalyScoreClass}">
                                    Anomaly Score: ${line.anomaly_score.toFixed(3)}
                                </div>
                            </div>
                        `;
                        container.appendChild(card);

                        // Update metric values
                        document.getElementById(`${lineId}-temp`).textContent = line.sensors.temperature.toFixed(1) + '°C';
                        document.getElementById(`${lineId}-humidity`).textContent = line.sensors.humidity.toFixed(1) + '%';
                        document.getElementById(`${lineId}-sound`).textContent = line.sensors.sound_level.toFixed(1) + 'dB';
                    });
                    
                    // Update averages
                    if (count > 0) {
                        avgTemp /= count;
                        avgHumidity /= count;
                        avgSound /= count;
                        avgAnomaly /= count;
                        
                        // Only append new data if charts are loaded
                        if (chartsLoaded) {
                            updateChart(charts.temperature, avgTemp);
                            updateChart(charts.humidity, avgHumidity);
                            updateChart(charts.sound, avgSound);
                        }
                        updateAnomalyTrend(avgAnomaly);
                        updateCorrelationChart(avgTemp, avgHumidity, avgSound);
                    }
                    
                    // Update system statistics
                    updateSystemStats(data);
                })
                .catch(error => {
                    console.error('Error fetching production lines:', error);
                });
        }

        // Update every 3 seconds for more responsive dashboard
        setInterval(updateDashboard, 3000);
        updateDashboard(); // Initial update
        
        console.log('Dashboard update cycle started');
    </script>
</body>
</html> 